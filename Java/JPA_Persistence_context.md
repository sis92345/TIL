# 1. JPA : 영속성 컨텍스트

영속성 컨텍스트는 엔티티를 영구 저장하는 환경을 말한다. 엔티티 매니저를 사용해서 엔티티를 저장하거나, 조회하면 엔티티 매니저는 영속성 컨텍스트를 보관하고 관리한다.

일반적으로 JPA에서 `persist(Entity)`를 사용하면 **간단히 DB에 데이터가 저장된다고 표현했지만 정확히 `persist()` 는 엔티티 매니저를 사용해서 회원 엔티티를 영속성 컨텍스트에 저장한다.** 

영속성 컨텍스트를 사용해서 엔티티를 관리하는 이유는 아래와 같은 장점이 있기 때문이다.

- 1차 캐시
- 동일성 보장
- 트랜잭션을 지원하는 쓰기 지원
- 변경 감지
- 지연 로딩

# 2. 엔티티의 생명주기

<img width="481" alt="영속성" src="https://user-images.githubusercontent.com/68282095/175769635-2ae59650-1a27-457c-82f7-5dd551b0e341.png">

엔티티에는 4가지 상태가 존재한다.

1. 비영속 ( new / transient ) : 영속성 컨텍스트와 전혀 관계 없는 상태

   - 이 객체를 생성한 직후에는 영속성 컨텍스트나 DB와는 상관이 없다. 이를 비영속 상태라고 한다.

     ```
     Member member = new Member();
     member.setId( "test1" );
     member.setUserName( "테스터" );
     ```

2. 영속 (managed) : 영속성 컨텍스트에 저장된 상태

   - 비영속 상태인 객체를 `persist()` 를 사용해서 영속성 컨텍스트에 저장했다. 이를 영속 상태라고 한다.

     ```
     em.persist( member );
     ```

3. 준영속 (detached) : 영속성 컨텍스트에 저장되었다가 분리된 상태

   - `detach()`를 사용해서 영속성 컨텍스트가 관리하지 않음
   - close()나 clear()를 사용해서 영속성 컨텍스트를 초기화해도 영속성 컨텍스트는 준영속 상태가 된다.

4. 삭제 (removed) : 삭제된 상태

   - 엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제한다.

# 3. 영속성 컨텍스트의 특징

1. 영속성 컨텍스트와 식별자 값
   - 영속성 컨텍스트는 엔티티를 식별자 값( @Id )으로 구분한다. **따라서 영속 상태는 식별자 값이 반드시 있어야 한다.**
2. 영속성 컨텍스트와 DB 저장
   - JPA에서 *트렌잭션을 커밋하는 순간* 영속성 컨텍스트에 새로 저장된 값을 반영한다. 이를 **flush**라고 한다.



